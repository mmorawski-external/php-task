<?php

namespace App\Test\Service;

use App\Service\ApiExchangeRateProvider;
use GuzzleHttp\Client;
use GuzzleHttp\Handler\MockHandler;
use GuzzleHttp\HandlerStack;
use GuzzleHttp\Psr7\Response;
use PHPUnit\Framework\TestCase;

class ApiExchangeRateProviderTest extends TestCase
{
    public function testAbc(): void
    {
        $mock = new MockHandler([
            new Response(200, body: '{"result":"success","provider":"https://www.exchangerate-api.com","documentation":"https://www.exchangerate-api.com/docs/free","terms_of_use":"https://www.exchangerate-api.com/terms","time_last_update_unix":1718323351,"time_last_update_utc":"Fri, 14 Jun 2024 00:02:31 +0000","time_next_update_unix":1718411261,"time_next_update_utc":"Sat, 15 Jun 2024 00:27:41 +0000","time_eol_unix":0,"base_code":"EUR","rates":{"EUR":1,"AED":3.951013,"AFN":76.632156,"ALL":100.458875,"AMD":419.001939,"ANG":1.925749,"AOA":932.651154,"ARS":970.588356,"AUD":1.620732,"AWG":1.925749,"AZN":1.836781,"BAM":1.95583,"BBD":2.151675,"BDT":126.412863,"BGN":1.95583,"BHD":0.404515,"BIF":3086.911756,"BMD":1.075838,"BND":1.453165,"BOB":7.476082,"BRL":5.835591,"BSD":1.075838,"BTN":90.017084,"BWP":14.742758,"BYN":3.497084,"BZD":2.151675,"CAD":1.478019,"CDF":3064.638889,"CHF":0.962494,"CLP":990.808719,"CNY":7.811849,"COP":4351.877281,"CRC":568.400398,"CUP":25.820101,"CVE":110.265,"CZK":24.71106,"DJF":191.198924,"DKK":7.460294,"DOP":64.030121,"DZD":145.45964,"EGP":51.491774,"ERN":16.137563,"ETB":62.348782,"FJD":2.419555,"FKP":0.843062,"FOK":7.460294,"GBP":0.842799,"GEL":3.097586,"GGP":0.843062,"GHS":16.339723,"GIP":0.843062,"GMD":70.443982,"GNF":9250.567539,"GTQ":8.389358,"GYD":225.925597,"HKD":8.406015,"HNL":26.683422,"HRK":7.5345,"HTG":143.405979,"HUF":396.5216,"IDR":17506.843418,"ILS":3.994652,"IMP":0.843062,"INR":90.017642,"IQD":1414.448718,"IRR":45953.809719,"ISK":149.297766,"JEP":0.843062,"JMD":167.711503,"JOD":0.762769,"JPY":168.943794,"KES":138.690471,"KGS":93.939077,"KHR":4472.716216,"KID":1.620674,"KMF":491.96775,"KRW":1482.708053,"KWD":0.330147,"KYD":0.896531,"KZT":486.050401,"LAK":23492.584341,"LBP":96287.460097,"LKR":327.867992,"LRD":209.090425,"LSL":19.81022,"LYD":5.248335,"MAD":10.724118,"MDL":19.156388,"MGA":4785.981818,"MKD":61.571,"MMK":2753.523385,"MNT":3617.995515,"MOP":8.658092,"MRU":42.558956,"MUR":49.951049,"MVR":16.667897,"MWK":1880.975436,"MXN":19.88692,"MYR":5.074738,"MZN":68.903094,"NAD":19.81022,"NGN":1644.134747,"NIO":39.678341,"NOK":11.441627,"NPR":144.027334,"NZD":1.744025,"OMR":0.413656,"PAB":1.075838,"PEN":4.0657,"PGK":4.168921,"PHP":63.093722,"PKR":299.785435,"PLN":4.345997,"PYG":8098.213501,"QAR":3.916049,"RON":4.977406,"RSD":117.075581,"RUB":95.034064,"RWF":1449.020903,"SAR":4.034391,"SBD":9.084679,"SCR":15.201779,"SDG":483.183942,"SEK":11.253521,"SGD":1.45317,"SHP":0.843062,"SLE":24.709671,"SLL":24709.698173,"SOS":617.501866,"SRD":34.284338,"SSP":1942.860296,"STN":24.5,"SYP":13911.297009,"SZL":19.81022,"THB":39.509168,"TJS":11.676913,"TMT":3.780912,"TND":3.366877,"TOP":2.503035,"TRY":34.889445,"TTD":7.481875,"TVD":1.620674,"TWD":34.809133,"TZS":2835.038704,"UAH":43.976606,"UGX":4036.077581,"USD":1.07585,"UYU":42.190472,"UZS":13631.244312,"VES":39.222657,"VND":27377.937871,"VUV":128.513684,"WST":2.9222,"XAF":655.957,"XCD":2.904761,"XDR":0.816264,"XOF":655.957,"XPF":119.332,"YER":270.378141,"ZAR":19.810266,"ZMW":28.590909,"ZWL":14.9322}}'),
        ]);

        $handlerStack = HandlerStack::create($mock);
        $client = new Client(['handler' => $handlerStack]);

        $sut = new ApiExchangeRateProvider($client);
        $this->assertEqualsWithDelta(4.345997, $sut->getExchangeRateForCurrency('PLN'), 0.01);
    }

    public function testCurrencyNotFound(): void
    {
        $mock = new MockHandler([
            new Response(200, body: '{"result":"success","provider":"https://www.exchangerate-api.com","documentation":"https://www.exchangerate-api.com/docs/free","terms_of_use":"https://www.exchangerate-api.com/terms","time_last_update_unix":1718323351,"time_last_update_utc":"Fri, 14 Jun 2024 00:02:31 +0000","time_next_update_unix":1718411261,"time_next_update_utc":"Sat, 15 Jun 2024 00:27:41 +0000","time_eol_unix":0,"base_code":"EUR","rates":{"EUR":1,"AED":3.951013,"AFN":76.632156,"ALL":100.458875,"AMD":419.001939,"ANG":1.925749,"AOA":932.651154,"ARS":970.588356,"AUD":1.620732,"AWG":1.925749,"AZN":1.836781,"BAM":1.95583,"BBD":2.151675,"BDT":126.412863,"BGN":1.95583,"BHD":0.404515,"BIF":3086.911756,"BMD":1.075838,"BND":1.453165,"BOB":7.476082,"BRL":5.835591,"BSD":1.075838,"BTN":90.017084,"BWP":14.742758,"BYN":3.497084,"BZD":2.151675,"CAD":1.478019,"CDF":3064.638889,"CHF":0.962494,"CLP":990.808719,"CNY":7.811849,"COP":4351.877281,"CRC":568.400398,"CUP":25.820101,"CVE":110.265,"CZK":24.71106,"DJF":191.198924,"DKK":7.460294,"DOP":64.030121,"DZD":145.45964,"EGP":51.491774,"ERN":16.137563,"ETB":62.348782,"FJD":2.419555,"FKP":0.843062,"FOK":7.460294,"GBP":0.842799,"GEL":3.097586,"GGP":0.843062,"GHS":16.339723,"GIP":0.843062,"GMD":70.443982,"GNF":9250.567539,"GTQ":8.389358,"GYD":225.925597,"HKD":8.406015,"HNL":26.683422,"HRK":7.5345,"HTG":143.405979,"HUF":396.5216,"IDR":17506.843418,"ILS":3.994652,"IMP":0.843062,"INR":90.017642,"IQD":1414.448718,"IRR":45953.809719,"ISK":149.297766,"JEP":0.843062,"JMD":167.711503,"JOD":0.762769,"JPY":168.943794,"KES":138.690471,"KGS":93.939077,"KHR":4472.716216,"KID":1.620674,"KMF":491.96775,"KRW":1482.708053,"KWD":0.330147,"KYD":0.896531,"KZT":486.050401,"LAK":23492.584341,"LBP":96287.460097,"LKR":327.867992,"LRD":209.090425,"LSL":19.81022,"LYD":5.248335,"MAD":10.724118,"MDL":19.156388,"MGA":4785.981818,"MKD":61.571,"MMK":2753.523385,"MNT":3617.995515,"MOP":8.658092,"MRU":42.558956,"MUR":49.951049,"MVR":16.667897,"MWK":1880.975436,"MXN":19.88692,"MYR":5.074738,"MZN":68.903094,"NAD":19.81022,"NGN":1644.134747,"NIO":39.678341,"NOK":11.441627,"NPR":144.027334,"NZD":1.744025,"OMR":0.413656,"PAB":1.075838,"PEN":4.0657,"PGK":4.168921,"PHP":63.093722,"PKR":299.785435,"PLN":4.345997,"PYG":8098.213501,"QAR":3.916049,"RON":4.977406,"RSD":117.075581,"RUB":95.034064,"RWF":1449.020903,"SAR":4.034391,"SBD":9.084679,"SCR":15.201779,"SDG":483.183942,"SEK":11.253521,"SGD":1.45317,"SHP":0.843062,"SLE":24.709671,"SLL":24709.698173,"SOS":617.501866,"SRD":34.284338,"SSP":1942.860296,"STN":24.5,"SYP":13911.297009,"SZL":19.81022,"THB":39.509168,"TJS":11.676913,"TMT":3.780912,"TND":3.366877,"TOP":2.503035,"TRY":34.889445,"TTD":7.481875,"TVD":1.620674,"TWD":34.809133,"TZS":2835.038704,"UAH":43.976606,"UGX":4036.077581,"USD":1.07585,"UYU":42.190472,"UZS":13631.244312,"VES":39.222657,"VND":27377.937871,"VUV":128.513684,"WST":2.9222,"XAF":655.957,"XCD":2.904761,"XDR":0.816264,"XOF":655.957,"XPF":119.332,"YER":270.378141,"ZAR":19.810266,"ZMW":28.590909,"ZWL":14.9322}}'),
        ]);

        $handlerStack = HandlerStack::create($mock);
        $client = new Client(['handler' => $handlerStack]);

        $this->expectException(\RuntimeException::class);
        $sut = new ApiExchangeRateProvider($client);
        $sut->getExchangeRateForCurrency('XYZ');
    }
}
